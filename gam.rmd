Making the model:
```{r}
library(mgcv)
nfldata <- read.csv("nflmodeldata.csv")
nfldata$margin_time_ratio <- nfldata$expected_margin/(nfldata$game_seconds_remaining + 1)

set.seed(143)

test.id = sample(seq(1,nrow(nfldata), 1), floor(nrow(nfldata)*0.3))
nfldata_test = nfldata[test.id,]
nfldata_train = nfldata[-test.id,]

model <- mgcv::bam(posteam_won ~ s(expected_margin) + s(game_seconds_remaining) + s(margin_time_ratio), data = nfldata_train, family = "binomial")

summary(model)

RMSE = function(y,yhat){
  SSE = sum((y-yhat)^2, na.rm = T) 
  return(sqrt(SSE/length(y)))
}

RMSE(nfldata_test$posteam_won, predict(model, newdata = nfldata_test, type = "response"))
RMSE(nfldata_train$posteam_won, predict(model, newdata = nfldata_train, type = "response"))
```

Store Python expected points for each play type as lists so we can make predictions
```{r}
fg <- c(2.0691401188740155, 2.067562805633789, 2.0640507889564477, 2.0586040688419915, 2.051222645290421, 2.0419065183017358, 2.0306556878759356, 2.0174701540130204, 2.0023499167129906, 1.9852949759758456, 1.9663053318015566, 1.9430371921769591, 1.932635522734602, 1.8880091726294674, 1.8554913841355667, 1.8448381062531611, 1.7709192506103788, 1.7533943178999603, 1.6902095011653844, 1.6813887932772886, 1.6222800607190073, 1.5840962355641235, 1.5168374625237637, 1.4457640047321672, 1.4060966006862619, 1.3670960554653078, 1.326841144644638, 1.1977826092254886, 1.1856770497420035, 1.1267017869096694, 1.0369470426808456, 0.9425328674514785, 0.8879458443818906, 0.8369062989964742, 0.6485775141600232, 0.5268807213750898, 0.47444281236913066, 0.20253086288703215, 0.06865254367066898, -0.173516608131408, -0.32184415980130576, -0.5775879770266901, -0.8809079847211397, -0.9621640111800042, -1.3818163140558335, -1.5820015700402532, -1.809759678205152, -2.0276579067944063, -2.0795791711712317, -2.142280264974, -2.502380120838778, -2.6564885496183206, -2.8511749347258486, -2.9338549075391183, -2.9160530191458025, -2.984682713347921, -3.171823568136932, -3.00202565833896, -3.062453531598513, -3.211203633610901, -3.169811320754717, -3.436838390966831, -3.4223412394797244, -3.4832214765100673, -3.5836092715231787, -3.62874251497006, -3.4954337899543377, -3.6327361563517915, -3.702770780856423, -3.8111824014665445, -3.8746518105849583, -3.8535564853556483, -3.9262295081967213, -4.039575289575289, -3.9930830039525693, -4.017970401691332, -4.238263950398583, -4.133083411433927, -4.305015353121801, -4.171487603305785, -4.231768231768232, -4.3526011560693645, -4.383891213389122, -4.644599303135888, -4.558679706601467, -4.6678321678321675, -4.882211538461538, -4.931506849315069, -5.195402298850575, -5.188144329896907, -5.433887043189369, -10, -10, -10, -10, -10, -10, -10, -10)

punt <- c(-0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.5363859362224039, -0.6826979472140763, -0.7849145550972304, -0.6194690265486725, -0.6194690265486725, -0.8991007468373724, -0.8991007468373724, -1.0405569007263922, -0.909358446144791, -1.0361663652802893, -1.1030092592592593, -1.1030092592592593, -1.3278249218401073, -1.2340425531914894, -1.2792022792022792, -1.5296969696969698, -1.5296969696969698, -1.3975155279503106, -1.457022076092062, -1.457022076092062, -1.52651696129957, -1.6115241635687731, -1.597165991902834, -1.597165991902834, -1.786480686695279, -1.6777777777777778, -1.6777777777777778, -2.0104109589041097, -2.0104109589041097, -2.139521956642579, -2.0250447227191413, -2.095766129032258, -2.28, -2.28, -2.299445471349353, -2.385923753665689, -2.2783783783783784, -2.549047282992237)

run_points <- read.csv("rundf.csv")
pass_points <- read.csv("passdf.csv")
```

Predicting:
```{r}
f <- function(ydline, ydstogo, margin_curr, time_left){
  predictions <- c(0, 0, 0, 0)
  
  x_punt <- data.frame("expected_margin" = margin_curr + punt[ydline], "game_seconds_remaining" = time_left, "margin_time_ratio" = (margin_curr + punt[ydline])/(time_left+1))
  predictions[1] = mgcv::predict.bam(model, newdata = x_punt, type = "response")[1]
  
  x_fg <- data.frame("expected_margin" = margin_curr + fg[ydline], "game_seconds_remaining" = time_left, "margin_time_ratio" = (margin_curr + fg[ydline])/(time_left+1))
  predictions[2] = mgcv::predict.bam(model, newdata = x_fg, type = "response")[1]
  
  x_run <- data.frame("expected_margin" = margin_curr + run_points[[ydline+1]][ydstogo], "game_seconds_remaining" = time_left, "margin_time_ratio" = (margin_curr + run_points[[ydline+1]][ydstogo])/(time_left+1))
  predictions[3] = mgcv::predict.bam(model, newdata = x_run, type = "response")[1]
  
  x_pass <- data.frame("expected_margin" = margin_curr + pass_points[[ydline+1]][ydstogo], "game_seconds_remaining" = time_left, "margin_time_ratio" = (margin_curr + pass_points[[ydline+1]][ydstogo])/(time_left+1))
  predictions[4] = mgcv::predict.bam(model, newdata = x_pass, type = "response")[1]
  print(predictions)
  return(which.max(predictions))
}
```

```{r}
x <- data.frame("expected_margin" = 2, "game_seconds_remaining" = 999, "margin_time_ratio" = 0.002)
predicted <- mgcv::predict.bam(model, newdata = x, type = "response")

print(predicted[1])
```

```{r}
test <- c()
for(ydline in 1:99){
  for(ydtogo in 1:20){
    test = c(test, f(ydline, ydtogo, -7, 600))
  }
}

testMat <- matrix(test, nrow = 20)
for(i in 1:99){
  for(j in 1:20){
    if(i < j){
      testMat[j, i] = 5
    }
    if((10-j)+i>99){
      testMat[j, i] = 5
    }
  }
}
testReverted <- as.numeric(testMat)

library(reshape2); library(ggplot2)

col <- c("red", "blue", "green", "yellow", "white")
colnames(testMat) <- seq(1, 99, by = 1)
df <- data.frame(ydtogo = rep(1:20, 99), ydline = rep(99:1, each = 20), decision = testReverted)
p<-ggplot(df,aes(x=max(ydline)+1-ydline,y=ydtogo))+
    #tile layer
    geom_tile(aes(fill=factor(decision))) +
    #setting the color
    scale_fill_manual(
        "Play Type",
        values=col,
        breaks=c("1","2","3","4","5"),
        labels=c("Punt","Field Goal", "Run", "Pass","Impossible")) +
    scale_y_reverse() +
    ggtitle("NFL Fourth Down, 10 Min. Remaining \n and Score Margin -7") +
    theme(plot.title = element_text(hjust = 0.5)) +
    xlab("Yardline") + 
    ylab("Yards to Go")

p

f(8, 5, -10, 60)
```